import pandas as pd
import decimal
import psycopg2
from datetime import datetime, timedelta
from google_sheets_utils import add_data_to_sheet_without_headers_with_format
from config_loader import load_config
from context import current_mode
from collections import defaultdict

CONFIG = load_config()

def fetch_data_from_db(query: str, params: tuple):
    """–°–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ PostgreSQL —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º psycopg2."""
    db_config = {
        "dbname": CONFIG["postgres_data_storage"]["database_name"],
        "user": CONFIG["postgres_data_storage"]["user"],
        "password": CONFIG["postgres_data_storage"]["password"],
        "host": CONFIG["postgres_data_storage"]["host"],
        "port": CONFIG["postgres_data_storage"]["port"]
    }

    try:
        conn = psycopg2.connect(**db_config)
        cursor = conn.cursor()

        cursor.execute(query, params)
        rows = cursor.fetchall()
        column_names = [desc[0] for desc in cursor.description]

        cursor.close()
        conn.close()

        data = [dict(zip(column_names, row)) for row in rows]
        return data

    except psycopg2.Error as e:
        raise Exception(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö: {e}")


def process_wb_reports(date_from: str, date_to: str, seller_legal: str, spreadsheet_id: str):
    """
    –ü–æ–ª—É—á–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –æ –ø—Ä–æ–¥–∞–∂–∞—Ö Wildberries –∏–∑ –ë–î –∏ –∑–∞–≥—Ä—É–∂–∞–µ—Ç –∏—Ö –≤ Google Sheets.
    """
    if seller_legal == "inter":
        seller_legal = "–ò–ù–¢–ï–†"
    elif seller_legal == "ut":
        seller_legal = "–ê–¢"
    elif seller_legal == "kravchik":
        seller_legal = "–ö–†–ê–í–ß–ò–ö"
    elif seller_legal == 'pomazanova':
        seller_legal = '–ü–û–ú–ê–ó–ê–ù–û–í–ê'
    elif seller_legal == 'avangard_seller':
        seller_legal = 'avangard_seller'
    else:
        raise ValueError(f"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ —é—Ä–∏–¥–∏—á–µ—Å–∫–æ–µ –ª–∏—Ü–æ: {seller_legal}")

    mode = current_mode.get()

    # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —Å—Ç—Ä–æ–∫–∏ –≤ datetime.date
    date_from_dt = datetime.strptime(date_from, "%d.%m.%Y").date()
    date_to_dt = datetime.strptime(date_to, "%d.%m.%Y").date()


    if mode == "days":
        date_from_dt -= timedelta(days=3)

    query = """
        SELECT * FROM wb_sale_report
        WHERE date BETWEEN %s AND %s
        AND legal_entity = %s
    """


    data = fetch_data_from_db(query, (date_from_dt, date_to_dt, seller_legal))

    if not data:
        print("‚ö† –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∑–∞–ø–∏—Å–∏ –≤ Google Sheets.")
        return

    data = [dict(record) for record in data]

    df = pd.DataFrame(data)

    # –ú–∞–ø–ø–∏–Ω–≥ –∫–æ–ª–æ–Ω–æ–∫, –∫–æ—Ç–æ—Ä—ã–µ –µ—Å—Ç—å –≤ Google Sheets
    column_mapping = {
        "–ù–æ–º–µ—Ä –ø–æ—Å—Ç–∞–≤–∫–∏": "–ù–æ–º–µ—Ä –ø–æ—Å—Ç–∞–≤–∫–∏",
        "–ü—Ä–µ–¥–º–µ—Ç": "–ü—Ä–µ–¥–º–µ—Ç",
        "–ö–æ–¥ –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä—ã": "–ö–æ–¥ –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä—ã",
        "–ë—Ä–µ–Ω–¥": "–ë—Ä–µ–Ω–¥",
        "–ê—Ä—Ç–∏–∫—É–ª –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞": "–ê—Ä—Ç–∏–∫—É–ª –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞",
        "–ù–∞–∑–≤–∞–Ω–∏–µ": "–ù–∞–∑–≤–∞–Ω–∏–µ",
        "–†–∞–∑–º–µ—Ä": "–†–∞–∑–º–µ—Ä",
        "–ë–∞—Ä–∫–æ–¥": "–ë–∞—Ä–∫–æ–¥",
        "–¢–∏–ø –¥–æ–∫—É–º–µ–Ω—Ç–∞": "–¢–∏–ø –¥–æ–∫—É–º–µ–Ω—Ç–∞",
        "–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ–ø–ª–∞—Ç—ã": "–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ–ø–ª–∞—Ç—ã",
        "–î–∞—Ç–∞ –∑–∞–∫–∞–∑–∞ –ø–æ–∫—É–ø–∞—Ç–µ–ª–µ–º": "–î–∞—Ç–∞ –∑–∞–∫–∞–∑–∞ –ø–æ–∫—É–ø–∞—Ç–µ–ª–µ–º",
        "–î–∞—Ç–∞ –ø—Ä–æ–¥–∞–∂–∏": "–î–∞—Ç–∞ –ø—Ä–æ–¥–∞–∂–∏",
        "–ö–æ–ª-–≤–æ": "–ö–æ–ª-–≤–æ",
        "–¶–µ–Ω–∞ —Ä–æ–∑–Ω–∏—á–Ω–∞—è": "–¶–µ–Ω–∞ —Ä–æ–∑–Ω–∏—á–Ω–∞—è",
        "–í–∞–π–ª–¥–±–µ—Ä—Ä–∏–∑ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–ª –¢–æ–≤–∞—Ä (–ü—Ä)": "–í–∞–π–ª–¥–±–µ—Ä—Ä–∏–∑ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–ª –¢–æ–≤–∞—Ä (–ü—Ä)",
        "–°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω—ã–π –ø—Ä–æ–¥—É–∫—Ç–æ–≤—ã–π –¥–∏—Å–∫–æ–Ω": "–°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω—ã–π –ø—Ä–æ–¥—É–∫—Ç–æ–≤—ã–π –¥–∏—Å–∫–æ–Ω—Ç, %",
        "–ü—Ä–æ–º–æ–∫–æ–¥ percent": "–ü—Ä–æ–º–æ–∫–æ–¥ %",
        "–ò—Ç–æ–≥–æ–≤–∞—è —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–∞—è —Å–∫–∏–¥–∫–∞, perce": "–ò—Ç–æ–≥–æ–≤–∞—è —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–∞—è —Å–∫–∏–¥–∫–∞, %",
        "–¶–µ–Ω–∞ —Ä–æ–∑–Ω–∏—á–Ω–∞—è —Å —É—á–µ—Ç–æ–º —Å–æ–≥–ª–∞—Å–æ–≤–∞": "–¶–µ–Ω–∞ —Ä–æ–∑–Ω–∏—á–Ω–∞—è —Å —É—á–µ—Ç–æ–º —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ–π —Å–∫–∏–¥–∫–∏",
        "–†–∞–∑–º–µ—Ä —Å–Ω–∏–∂–µ–Ω–∏—è –∫–í–í –∏–∑-–∑–∞ —Ä–µ–π—Ç–∏–Ω–≥–∞": "–†–∞–∑–º–µ—Ä —Å–Ω–∏–∂–µ–Ω–∏—è –∫–í–í –∏–∑-–∑–∞ —Ä–µ–π—Ç–∏–Ω–≥–∞, %",
        "–†–∞–∑–º–µ—Ä —Å–Ω–∏–∂–µ–Ω–∏—è –∫–í–í –∏–∑-–∑–∞ –∞–∫—Ü–∏–∏, perc": "–†–∞–∑–º–µ—Ä —Å–Ω–∏–∂–µ–Ω–∏—è –∫–í–í –∏–∑-–∑–∞ –∞–∫—Ü–∏–∏, %",
        "–°–∫–∏–¥–∫–∞ –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–≥–æ –ü–æ–∫—É–ø–∞—Ç–µ–ª—è (–°–ü": "–°–∫–∏–¥–∫–∞ –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–≥–æ –ü–æ–∫—É–ø–∞—Ç–µ–ª—è (–°–ü–ü), %",
        "–†–∞–∑–º–µ—Ä –∫–í–í, percent": "–†–∞–∑–º–µ—Ä –∫–í–í, %",
        "–†–∞–∑–º–µ—Ä –∫–í–í –±–µ–∑ –ù–î–°, percent –ë–∞–∑–æ–≤—ã–π": "–†–∞–∑–º–µ—Ä –∫–í–í –±–µ–∑ –ù–î–°, % –ë–∞–∑–æ–≤—ã–π",
        "–ò—Ç–æ–≥–æ–≤—ã–π –∫–í–í –±–µ–∑ –ù–î–°, percent": "–ò—Ç–æ–≥–æ–≤—ã–π –∫–í–í –±–µ–∑ –ù–î–°, %",
        "–í–æ–∑–Ω–∞–≥—Ä–∞–∂–¥–µ–Ω–∏–µ —Å –ø—Ä–æ–¥–∞–∂ –¥–æ –≤—ã—á–µ—Ç–∞": "–í–æ–∑–Ω–∞–≥—Ä–∞–∂–¥–µ–Ω–∏–µ —Å –ø—Ä–æ–¥–∞–∂ –¥–æ –≤—ã—á–µ—Ç–∞ —É—Å–ª—É–≥ –ø–æ–≤–µ—Ä–µ–Ω–Ω–æ–≥–æ, –±–µ–∑ –ù–î–°",
        "–í–æ–∑–º–µ—â–µ–Ω–∏–µ –∑–∞ –≤—ã–¥–∞—á—É –∏ –≤–æ–∑–≤—Ä–∞—Ç —Ç–æ–≤": "–í–æ–∑–º–µ—â–µ–Ω–∏–µ –∑–∞ –≤—ã–¥–∞—á—É –∏ –≤–æ–∑–≤—Ä–∞—Ç —Ç–æ–≤–∞—Ä–æ–≤ –Ω–∞ –ü–í–ó",
        "–≠–∫–≤–∞–π—Ä–∏–Ω–≥/–ö–æ–º–∏—Å—Å–∏–∏ –∑–∞ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—é": "–≠–∫–≤–∞–π—Ä–∏–Ω–≥/–ö–æ–º–∏—Å—Å–∏–∏ –∑–∞ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—é –ø–ª–∞—Ç–µ–∂–µ–π",
        "–†–∞–∑–º–µ—Ä –∫–æ–º–∏—Å—Å–∏–∏ –∑–∞ —ç–∫–≤–∞–π—Ä–∏–Ω–≥/–ö–æ–º–∏": "–†–∞–∑–º–µ—Ä –∫–æ–º–∏—Å—Å–∏–∏ –∑–∞ —ç–∫–≤–∞–π—Ä–∏–Ω–≥/–ö–æ–º–∏—Å—Å–∏–∏ –∑–∞ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—é –ø–ª–∞—Ç–µ–∂–µ–π, %",
        "–¢–∏–ø –ø–ª–∞—Ç–µ–∂–∞ –∑–∞ –≠–∫–≤–∞–π—Ä–∏–Ω–≥/–ö–æ–º–∏—Å—Å–∏–∏ ": "–¢–∏–ø –ø–ª–∞—Ç–µ–∂–∞ –∑–∞ –≠–∫–≤–∞–π—Ä–∏–Ω–≥/–ö–æ–º–∏—Å—Å–∏–∏ –∑–∞ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—é –ø–ª–∞—Ç–µ–∂–µ–π",
        "–í–æ–∑–Ω–∞–≥—Ä–∞–∂–¥–µ–Ω–∏–µ –í–∞–π–ª–¥–±–µ—Ä—Ä–∏–∑ (–í–í), –±": "–í–æ–∑–Ω–∞–≥—Ä–∞–∂–¥–µ–Ω–∏–µ –í–∞–π–ª–¥–±–µ—Ä—Ä–∏–∑ (–í–í), –±–µ–∑ –ù–î–°",
        "–ù–î–° —Å –í–æ–∑–Ω–∞–≥—Ä–∞–∂–¥–µ–Ω–∏—è –í–∞–π–ª–¥–±–µ—Ä—Ä–∏–∑": "–ù–î–° —Å –í–æ–∑–Ω–∞–≥—Ä–∞–∂–¥–µ–Ω–∏—è –í–∞–π–ª–¥–±–µ—Ä—Ä–∏–∑",
        "–ö –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–∏—é –ü—Ä–æ–¥–∞–≤—Ü—É –∑–∞ —Ä–µ–∞–ª–∏–∑": "–ö –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–∏—é –ü—Ä–æ–¥–∞–≤—Ü—É –∑–∞ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π –¢–æ–≤–∞—Ä",
        "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ—Å—Ç–∞–≤–æ–∫": "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ—Å—Ç–∞–≤–æ–∫",
        "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–æ–∑–≤—Ä–∞—Ç–∞": "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–æ–∑–≤—Ä–∞—Ç–∞",
        "–£—Å–ª—É–≥–∏ –ø–æ –¥–æ—Å—Ç–∞–≤–∫–µ —Ç–æ–≤–∞—Ä–∞ –ø–æ–∫—É–ø–∞—Ç": "–£—Å–ª—É–≥–∏ –ø–æ –¥–æ—Å—Ç–∞–≤–∫–µ —Ç–æ–≤–∞—Ä–∞ –ø–æ–∫—É–ø–∞—Ç–µ–ª—é",
        "–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –¥–µ–π—Å—Ç–≤–∏—è —Ñ–∏–∫—Å–∞—Ü–∏–∏": "–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –¥–µ–π—Å—Ç–≤–∏—è —Ñ–∏–∫—Å–∞—Ü–∏–∏",
        "–î–∞—Ç–∞ –∫–æ–Ω—Ü–∞ –¥–µ–π—Å—Ç–≤–∏—è —Ñ–∏–∫—Å–∞—Ü–∏–∏": "–î–∞—Ç–∞ –∫–æ–Ω—Ü–∞ –¥–µ–π—Å—Ç–≤–∏—è —Ñ–∏–∫—Å–∞—Ü–∏–∏",
        "–ü—Ä–∏–∑–Ω–∞–∫ —É—Å–ª—É–≥–∏ –ø–ª–∞—Ç–Ω–æ–π –¥–æ—Å—Ç–∞–≤–∫–∏": "–ü—Ä–∏–∑–Ω–∞–∫ —É—Å–ª—É–≥–∏ –ø–ª–∞—Ç–Ω–æ–π –¥–æ—Å—Ç–∞–≤–∫–∏",
        "–û–±—â–∞—è —Å—É–º–º–∞ —à—Ç—Ä–∞—Ñ–æ–≤": "–û–±—â–∞—è —Å—É–º–º–∞ —à—Ç—Ä–∞—Ñ–æ–≤",
        "–î–æ–ø–ª–∞—Ç—ã": "–î–æ–ø–ª–∞—Ç—ã",
        "–í–∏–¥—ã –ª–æ–≥–∏—Å—Ç–∏–∫–∏, —à—Ç—Ä–∞—Ñ–æ–≤ –∏ –¥–æ–ø–ª–∞—Ç": "–í–∏–¥—ã –ª–æ–≥–∏—Å—Ç–∏–∫–∏, —à—Ç—Ä–∞—Ñ–æ–≤ –∏ –¥–æ–ø–ª–∞—Ç",
        "–°—Ç–∏–∫–µ—Ä –ú–ü": "–°—Ç–∏–∫–µ—Ä –ú–ü",
        "–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –±–∞–Ω–∫–∞-—ç–∫–≤–∞–π–µ—Ä–∞": "–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –±–∞–Ω–∫–∞-—ç–∫–≤–∞–π–µ—Ä–∞",
        "–ù–æ–º–µ—Ä –æ—Ñ–∏—Å–∞": "–ù–æ–º–µ—Ä –æ—Ñ–∏—Å–∞",
        "–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –æ—Ñ–∏—Å–∞ –¥–æ—Å—Ç–∞–≤–∫–∏": "–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –æ—Ñ–∏—Å–∞ –¥–æ—Å—Ç–∞–≤–∫–∏",
        "–ò–ù–ù –ø–∞—Ä—Ç–Ω–µ—Ä–∞": "–ò–ù–ù –ø–∞—Ä—Ç–Ω–µ—Ä–∞",
        "–ü–∞—Ä—Ç–Ω–µ—Ä": "–ü–∞—Ä—Ç–Ω–µ—Ä",
        "–°–∫–ª–∞–¥": "–°–∫–ª–∞–¥",
        "–°—Ç—Ä–∞–Ω–∞": "–°—Ç—Ä–∞–Ω–∞",
        "–¢–∏–ø –∫–æ—Ä–æ–±–æ–≤": "–¢–∏–ø –∫–æ—Ä–æ–±–æ–≤",
        "–ù–æ–º–µ—Ä —Ç–∞–º–æ–∂–µ–Ω–Ω–æ–π –¥–µ–∫–ª–∞—Ä–∞—Ü–∏–∏": "–ù–æ–º–µ—Ä —Ç–∞–º–æ–∂–µ–Ω–Ω–æ–π –¥–µ–∫–ª–∞—Ä–∞—Ü–∏–∏",
        "–ù–æ–º–µ—Ä —Å–±–æ—Ä–æ—á–Ω–æ–≥–æ –∑–∞–¥–∞–Ω–∏—è": "–ù–æ–º–µ—Ä —Å–±–æ—Ä–æ—á–Ω–æ–≥–æ –∑–∞–¥–∞–Ω–∏—è",
        "–ö–æ–¥ –º–∞—Ä–∫–∏—Ä–æ–≤–∫–∏": "–ö–æ–¥ –º–∞—Ä–∫–∏—Ä–æ–≤–∫–∏",
        "–®–ö": "–®–ö",
        "Srid": "Srid",
        "–í–æ–∑–º–µ—â–µ–Ω–∏–µ –∏–∑–¥–µ—Ä–∂–µ–∫ –ø–æ –ø–µ—Ä–µ–≤–æ–∑–∫–µ/": "–í–æ–∑–º–µ—â–µ–Ω–∏–µ –∏–∑–¥–µ—Ä–∂–µ–∫ –ø–æ –ø–µ—Ä–µ–≤–æ–∑–∫–µ/–ø–æ —Å–∫–ª–∞–¥—Å–∫–∏–º –æ–ø–µ—Ä–∞—Ü–∏—è–º —Å —Ç–æ–≤–∞—Ä–æ–º",
        "–û—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä –ø–µ—Ä–µ–≤–æ–∑–∫–∏": "–û—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä –ø–µ—Ä–µ–≤–æ–∑–∫–∏",
        "–•—Ä–∞–Ω–µ–Ω–∏–µ": "–•—Ä–∞–Ω–µ–Ω–∏–µ",
        "–£–¥–µ—Ä–∂–∞–Ω–∏—è": "–£–¥–µ—Ä–∂–∞–Ω–∏—è",
        "–ü–ª–∞—Ç–Ω–∞—è –ø—Ä–∏–µ–º–∫–∞": "–ü–ª–∞—Ç–Ω–∞—è –ø—Ä–∏–µ–º–∫–∞",
        "–§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç —Å–∫–ª–∞–¥–∞": "–§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç —Å–∫–ª–∞–¥–∞ –ø–æ –ø–æ—Å—Ç–∞–≤–∫–µ",
        "–ü—Ä–∏–∑–Ω–∞–∫ –ø—Ä–æ–¥–∞–∂–∏ —é—Ä–∏–¥–∏—á–µ—Å–∫–æ–º—É –ª–∏—Ü—É": "–ü—Ä–∏–∑–Ω–∞–∫ –ø—Ä–æ–¥–∞–∂–∏ —é—Ä–∏–¥–∏—á–µ—Å–∫–æ–º—É –ª–∏—Ü—É",
        "–°–∫–∏–¥–∫–∞ –ø–æ –ø—Ä–æ–≥—Ä–∞–º–º–µ —Å–æ—Ñ–∏–Ω–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–∏—è": "–°–∫–∏–¥–∫–∞ –ø–æ –ø—Ä–æ–≥—Ä–∞–º–º–µ —Å–æ—Ñ–∏–Ω–∞–Ω—Å–∏—Ä–æ–≤–∞",
        "–°–∫–∏–¥–∫–∞ Wibes, %": "–°–∫–∏–¥–∫–∞ Wibes, percent",
        "–ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ –í–æ–∑–Ω–∞–≥—Ä–∞–∂–¥–µ–Ω–∏—è –í–∞–π": "–ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ –í–æ–∑–Ω–∞–≥—Ä–∞–∂–¥–µ–Ω–∏—è –í–∞–π–ª–¥–±–µ—Ä—Ä–∏–∑ (–í–í)",
        "–í–∏–¥—ã –ª–æ–≥–∏—Å—Ç–∏–∫–∏, —à—Ç—Ä–∞—Ñ–æ–≤ –∏ –∫–æ—Ä—Ä–µ–∫—Ç–∏": "–í–∏–¥—ã –ª–æ–≥–∏—Å—Ç–∏–∫–∏, —à—Ç—Ä–∞—Ñ–æ–≤ –∏ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–æ–∫ –í–í",
        "–ü—Ä–æ–º–æ–∫–æ–¥, %": "–ü—Ä–æ–º–æ–∫–æ–¥, percent",
        "–°—É–º–º–∞ —É–¥–µ—Ä–∂–∞–Ω–Ω–∞—è –∑–∞ –Ω–∞—á–∏—Å–ª–µ–Ω–Ω—ã–µ –±": "–°—É–º–º–∞ —É–¥–µ—Ä–∂–∞–Ω–Ω–∞—è –∑–∞ –Ω–∞—á–∏—Å–ª–µ–Ω–Ω—ã–µ –±–∞–ª–ª—ã –ø—Ä–æ–≥—Ä–∞–º–º—ã –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏",
        "–ö–æ–º–ø–µ–Ω—Å–∞—Ü–∏—è —Å–∫–∏–¥–∫–∏ –ø–æ –ø—Ä–æ–≥—Ä–∞–º–º–µ –ª": "–ö–æ–º–ø–µ–Ω—Å–∞—Ü–∏—è —Å–∫–∏–¥–∫–∏ –ø–æ –ø—Ä–æ–≥—Ä–∞–º–º–µ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏",
    }

    source_col = "–í–∏–¥—ã –ª–æ–≥–∏—Å—Ç–∏–∫–∏, —à—Ç—Ä–∞—Ñ–æ–≤ –∏ –∫–æ—Ä—Ä–µ–∫—Ç–∏"
    targets = [
        "–í–∏–¥—ã –ª–æ–≥–∏—Å—Ç–∏–∫–∏, —à—Ç—Ä–∞—Ñ–æ–≤ –∏ –¥–æ–ø–ª–∞—Ç",
        "–í–∏–¥—ã –ª–æ–≥–∏—Å—Ç–∏–∫–∏, —à—Ç—Ä–∞—Ñ–æ–≤ –∏ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–æ–∫ –í–í",
    ]

    if source_col in df.columns:
        for target_col in targets:
            if target_col in df.columns:
                df[target_col] = df[source_col]
                print(f"üìé –ó–∞–º–µ–Ω–∏–ª–∏ –¥–∞–Ω–Ω—ã–µ –≤ '{target_col}' –∏–∑ '{source_col}'")
            else:
                print(f"‚ö† –°—Ç–æ–ª–±–µ—Ü '{target_col}' –Ω–µ –Ω–∞–π–¥–µ–Ω ‚Äî –Ω–µ —Å–º–æ–≥–ª–∏ –∑–∞–º–µ–Ω–∏—Ç—å.")
    else:
        print(f"‚ö† –°—Ç–æ–ª–±–µ—Ü '{source_col}' –Ω–µ –Ω–∞–π–¥–µ–Ω ‚Äî –∑–∞–º–µ–Ω–∞ –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞.")

    df.rename(columns=column_mapping, inplace=True)

    df.insert(0, "‚Ññ", range(1, len(df) + 1))  # –ù—É–º–µ—Ä–∞—Ü–∏—è —Å 1

    df_filtered = df.copy()
    # –£–¥–∞–ª—è–µ–º –Ω–µ–Ω—É–∂–Ω—ã–µ –∫–æ–ª–æ–Ω–∫–∏ –ø–µ—Ä–µ–¥ –∑–∞–≥—Ä—É–∑–∫–æ–π
    columns_to_remove = ["legal_entity", "uuid", "date", "–ù–æ–º–µ—Ä –∫–æ—Ä–æ–±–∞ –¥–ª—è –ø–ª–∞—Ç–Ω–æ–π –ø—Ä–∏–µ–º–∫–∏"]
    df.drop(columns=[col for col in columns_to_remove if col in df.columns], inplace=True)

    numeric_columns = [
        "–ò—Ç–æ–≥–æ–≤–∞—è —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–∞—è —Å–∫–∏–¥–∫–∞, %",
        "–†–∞–∑–º–µ—Ä —Å–Ω–∏–∂–µ–Ω–∏—è –∫–í–í –∏–∑-–∑–∞ —Ä–µ–π—Ç–∏–Ω–≥–∞, %",
        "–†–∞–∑–º–µ—Ä —Å–Ω–∏–∂–µ–Ω–∏—è –∫–í–í –∏–∑-–∑–∞ –∞–∫—Ü–∏–∏, %",
        "–°–∫–∏–¥–∫–∞ –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–≥–æ –ü–æ–∫—É–ø–∞—Ç–µ–ª—è (–°–ü–ü), %",
        "–†–∞–∑–º–µ—Ä –∫–í–í, %",
        "–†–∞–∑–º–µ—Ä –∫–í–í –±–µ–∑ –ù–î–°, % –ë–∞–∑–æ–≤—ã–π",
        "–ò—Ç–æ–≥–æ–≤—ã–π –∫–í–í –±–µ–∑ –ù–î–°, %",
        "–í–æ–∑–Ω–∞–≥—Ä–∞–∂–¥–µ–Ω–∏–µ —Å –ø—Ä–æ–¥–∞–∂ –¥–æ –≤—ã—á–µ—Ç–∞ —É—Å–ª—É–≥ –ø–æ–≤–µ—Ä–µ–Ω–Ω–æ–≥–æ, –±–µ–∑ –ù–î–°",
        "–†–∞–∑–º–µ—Ä –∫–æ–º–∏—Å—Å–∏–∏ –∑–∞ —ç–∫–≤–∞–π—Ä–∏–Ω–≥/–ö–æ–º–∏—Å—Å–∏–∏ –∑–∞ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—é –ø–ª–∞—Ç–µ–∂–µ–π, %",
        "–¢–∏–ø –ø–ª–∞—Ç–µ–∂–∞ –∑–∞ –≠–∫–≤–∞–π—Ä–∏–Ω–≥/–ö–æ–º–∏—Å—Å–∏–∏ –∑–∞ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—é –ø–ª–∞—Ç–µ–∂–µ–π",
        "–°–∫–∏–¥–∫–∞ –ø–æ –ø—Ä–æ–≥—Ä–∞–º–º–µ —Å–æ—Ñ–∏–Ω–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–∏—è",
        "–°–∫–∏–¥–∫–∞ Wibes, %",
        "–ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ –í–æ–∑–Ω–∞–≥—Ä–∞–∂–¥–µ–Ω–∏—è –í–∞–π–ª–¥–±–µ—Ä—Ä–∏–∑ (–í–í)",
        "–ü—Ä–æ–º–æ–∫–æ–¥, %",
    ]

    for col in numeric_columns:
        if col in df.columns:
            df[col] = df[col].astype(str)  # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ —Å—Ç—Ä–æ–∫—É
            df[col] = df[col].replace("nan", "").replace("None", "")  # –£–±–∏—Ä–∞–µ–º NaN
            df[col] = df[col].apply(lambda x: f"'{x}" if x.replace(".", "").isdigit() else x)
    print(f"üìå –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–æ–∫ –≤ DataFrame –ø–æ—Å–ª–µ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏: {len(df)}")

    if df.empty:
        print("‚ö† –î–∞–Ω–Ω—ã–µ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω—ã, –Ω–æ —Ç–µ–ø–µ—Ä—å DataFrame –ø—É—Å—Ç. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –∫–æ–ª–æ–Ω–æ–∫.")
        return
    # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º Decimal ‚Üí float
    for col in df.columns:
        if df[col].apply(lambda x: isinstance(x, decimal.Decimal)).any():
            print(f"‚ö† –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º Decimal ‚Üí float –≤ –∫–æ–ª–æ–Ω–∫–µ: {col}")
            df[col] = df[col].astype(float)
    print("‚úÖ –ì–æ—Ç–æ–≤–æ –∫ –∑–∞–≥—Ä—É–∑–∫–µ –≤ Google Sheets.")

    if mode == "days":
        # üîπ –ó–∞–≥—Ä—É–∂–∞–µ–º –≤–µ—Å—å –¥–∏–∞–ø–∞–∑–æ–Ω (4 –¥–Ω—è) –≤ "SalesReport(ext) - 4 days"
        add_data_to_sheet_without_headers_with_format(
            spreadsheet_id=spreadsheet_id,
            data=df,
            sheet_name="SalesReport(ext) - 4 days",
        )
        print("‚úÖ –ü—Ä–æ–¥–∞–∂–∏ (4 –¥–Ω—è) —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ Google Sheets.")

        # üîπ –¢–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ–º –∫–æ–ø–∏—é `df_filtered`, –≥–¥–µ –µ—Å—Ç—å "date"
        df_filtered["date"] = pd.to_datetime(df_filtered["date"], errors="coerce").dt.date  # –ü—Ä–∏–≤–æ–¥–∏–º –∫ `date`

        df_today = df_filtered[df_filtered["date"] == date_to_dt].copy()  # ‚úÖ –î–µ–ª–∞–µ–º –∫–æ–ø–∏—é

        df_today = df_today.drop(columns=[col for col in columns_to_remove if col in df_today.columns])
        print(f"üìå –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–æ–∫ –≤ DataFrame –ø–æ—Å–ª–µ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏: {len(df_today)}")
        print("‚úÖ –ì–æ—Ç–æ–≤–æ –∫ –∑–∞–≥—Ä—É–∑–∫–µ –≤ Google Sheets.")

        if not df_today.empty:
            add_data_to_sheet_without_headers_with_format(
                spreadsheet_id=spreadsheet_id,
                data=df_today,
                sheet_name="SalesReport(ext)",
            )
            print(f"‚úÖ –ü—Ä–æ–¥–∞–∂–∏ –∑–∞ {date_to_dt.strftime('%d.%m.%Y')} –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ Google Sheets (SalesReport(ext)).")
        else:
            print(f"‚ö† –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ {date_to_dt.strftime('%d.%m.%Y')} –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –≤ SalesReport(ext).")

        return

    # üîπ –ï—Å–ª–∏ mode != "days", –∑–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ –¥–∞–Ω–Ω—ã–µ
    print(f"üìå –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–æ–∫ –¥–ª—è SalesReport(ext): {len(df)}")
    add_data_to_sheet_without_headers_with_format(
        spreadsheet_id=spreadsheet_id,
        data=df,
        sheet_name="SalesReport(ext)",
    )
    print("‚úÖ –í—Å–µ –¥–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ Google Sheets.")

    print(f"‚úÖ –î–∞–Ω–Ω—ã–µ –¥–ª—è —é—Ä. –ª–∏—Ü–∞ '{seller_legal}' –∑–∞–≥—Ä—É–∂–µ–Ω—ã.")


if __name__ == "__main__":
    process_wb_reports("18.05.2025", "18.05.2025", "avangard_seller", "1PZOm64VMSDSz73HVzrC7zo0ezkgWN_QyUv4YZLvwE8A")

